Author: creshal@sayaka.ad.tao.at
Bug: https://github.com/axkibe/lsyncd/issues/220
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=767227
Subject: fix for crash and/or code execution in `, $, " in file names
 Sanitize mv arguments:
 .
 1. Fixes crashes on file names containing `, $ or "
 2. Also prevents shell execution of ``, $() â€¦ in file names, which can be
    used to gain remote shell access as lsyncd's (target) user.
--- a/default-rsyncssh.lua
+++ b/default-rsyncssh.lua
@@ -74,6 +74,8 @@
 	-- makes move local on target host
 	-- if the move fails, it deletes the source
 	if event.etype == 'Move' then
+		local path1 = event.path:gsub('"', '\\"'):gsub('`', '\\`'):gsub('%$', '\\%$')
+		local path2 = event.path2:gsub('"', '\\"'):gsub('`', '\\`'):gsub('%$', '\\%$')
 		log('Normal', 'Moving ',event.path,' -> ',event2.path)
 
 		spawn(
@@ -82,10 +84,10 @@
 			config.ssh._computed,
 			config.host,
 			'mv',
-			'\"' .. config.targetdir .. event.path .. '\"',
-			'\"' .. config.targetdir .. event2.path .. '\"',
+			'\"' .. config.targetdir .. path1 .. '\"',
+			'\"' .. config.targetdir .. path2 .. '\"',
 			'||', 'rm', '-rf',
-			'\"' .. config.targetdir .. event.path .. '\"')
+			'\"' .. config.targetdir .. path1 .. '\"')
 		return
 	end
 
